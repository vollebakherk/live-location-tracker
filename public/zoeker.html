<!DOCTYPE html>
<html>
<head>
    <title>Vossenjacht - Zoeker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #2c3e50;
            color: white;
        }
        .header {
            padding: 20px;
            background: #3498db;
            text-align: center;
        }
        .controls {
            padding: 15px;
            background: #34495e;
            text-align: center;
        }
        .player-info {
            padding: 10px;
            background: #2980b9;
            text-align: center;
            font-size: 14px;
        }
        button {
            padding: 12px 25px;
            margin: 5px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { background: #2980b9; }
        button.stop { background: #95a5a6; }
        button.stop:hover { background: #7f8c8d; }
        #status { 
            margin-top: 10px; 
            font-size: 14px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            min-height: 40px;
        }
        #map { flex-grow: 1; width: 100%; }
        .vos-alert {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .distance-info {
            background: #27ae60;
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Vossenjacht - ZOEKER</h1>
        <p>Vind de vos! Jouw locatie wordt gedeeld met andere zoekers.</p>
    </div>

    <div class="player-info">
        <strong>üë§ Jouw spelernaam:</strong> <span id="playerNameDisplay">Laden...</span>
    </div>

    <div class="controls">
        <button onclick="startSharing()">üìç Start Zoeken</button>
        <button class="stop" onclick="stopSharing()">‚èπÔ∏è Stop Zoeken</button>
        <div id="status">Klik op "Start Zoeken" om te beginnen</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        console.log('üéØ Zoeker wordt geladen...');
        
        let socket, map, markers = {};
        let watchId = null;
        let playerName = '';
        let TRACKER_ID = '';
        let vosLocation = null;

        // Genereer spelernaam
        const zoekerNamen = [
            "Speurder", "Jager", "Verkenner", "Trackster", "Zoekertje", 
            "Speurneus", "Jachtluipaard", "Spoorzoeker", "Detective", "Scout"
        ];
        
        // Wacht tot alles geladen is
        function waitForSocketIO(callback) {
            if (typeof io !== 'undefined') {
                console.log('‚úÖ Socket.io is geladen!');
                callback();
            } else {
                console.log('‚è≥ Wacht op socket.io...');
                setTimeout(function() {
                    waitForSocketIO(callback);
                }, 100);
            }
        }
        
        waitForSocketIO(function() {
            console.log('üöÄ Start zoeker initialisatie...');
            initializeZoeker();
        });

        function initializeZoeker() {
            console.log('üöÄ Initializing zoeker...');
            
            try {
                socket = io();
                console.log('‚úÖ Socket.io verbonden!');
                
                // Genereer tracker ID en naam
                TRACKER_ID = 'zoeker-' + Math.random().toString(36).substr(2, 8);
                const randomNaam = zoekerNamen[Math.floor(Math.random() * zoekerNamen.length)];
                const randomNummer = Math.floor(Math.random() * 99) + 1;
                playerName = `${randomNaam}${randomNummer}`;
                document.getElementById('playerNameDisplay').textContent = playerName;

                console.log('üë§ Zoeker:', playerName, 'ID:', TRACKER_ID);

                // Icons
                const icons = {
                    vos: L.divIcon({
                        className: 'vos-icon',
                        html: `
                            <div style="
                                background: #e74c3c;
                                width: 25px;
                                height: 25px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                color: white;
                                font-size: 12px;
                            ">ü¶ä</div>
                        `,
                        iconSize: [31, 31],
                        iconAnchor: [15, 15]
                    }),
                    zoeker: L.divIcon({
                        className: 'zoeker-icon',
                        html: `
                            <div style="
                                background: #3498db;
                                width: 22px;
                                height: 22px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 0 10px rgba(52, 152, 219, 0.8);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                color: white;
                                font-size: 10px;
                            ">üë§</div>
                        `,
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    })
                };

                // Initialiseer kaart
                map = L.map('map').setView([50.9010206, 5.3104384], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                console.log('üó∫Ô∏è Kaart ge√Ønitialiseerd');

                // Socket events
                socket.on('connect', () => {
                    console.log('‚úÖ Verbonden met vossenjacht server');
                    document.getElementById('status').innerHTML = 'üü¢ Verbonden - wacht op vos...';
                });

                socket.on('vosStatus', (data) => {
                    console.log('ü¶ä Vos status:', data);
                    if (data.hasVos) {
                        document.getElementById('status').innerHTML = 
                            `<div class="vos-alert">ü¶ä VOS ACTIEF: ${data.vosName} - Ga op jacht!</div>`;
                    } else {
                        document.getElementById('status').innerHTML = 
                            'üü° Wacht op vos... Er is nog geen vos actief.';
                    }
                });

                socket.on('locationUpdate', (location) => {
                    console.log('üìç Locatie ontvangen:', location.trackerId, location.isVos ? '(VOS)' : '');
                    updateMap(location);
                    
                    if (location.isVos) {
                        vosLocation = location;
                        updateVosDistance();
                    }
                });

                // Maak functies globaal beschikbaar
                window.startSharing = function() {
                    console.log('üìç Start zoeken clicked');
                    
                    if (!navigator.geolocation) {
                        alert('Geolocatie wordt niet ondersteund door je browser');
                        return;
                    }

                    document.getElementById('status').innerHTML = 
                        '<span style="color: #2ecc71;">üî¥ ZOEKEN LIVE - Je ziet alle spelers</span>';

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            sendLocationToServer(position);
                            startWatching();
                        },
                        (error) => {
                            handleLocationError(error);
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                }

                window.stopSharing = function() {
                    console.log('‚èπÔ∏è Stop zoeken');
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    document.getElementById('status').innerHTML = '‚èπÔ∏è Zoeken gestopt';
                    
                    if (markers[TRACKER_ID]) {
                        map.removeLayer(markers[TRACKER_ID]);
                        delete markers[TRACKER_ID];
                    }
                }

                function startWatching() {
                    watchId = navigator.geolocation.watchPosition(
                        sendLocationToServer,
                        handleLocationError,
                        { 
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 1000
                        }
                    );
                }

                function sendLocationToServer(position) {
                    const locationData = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        trackerId: TRACKER_ID,
                        name: playerName,
                        type: "zoeker"
                    };

                    console.log('üë§ Zoeker locatie:', locationData);
                    socket.emit('updateLocation', locationData);
                    
                    updateOwnMarker(locationData);
                }

                function updateOwnMarker(location) {
                    if (markers[TRACKER_ID]) {
                        map.removeLayer(markers[TRACKER_ID]);
                    }

                    markers[TRACKER_ID] = L.marker([location.lat, location.lng], { 
                        icon: icons.zoeker 
                    })
                    .addTo(map)
                    .bindPopup(`<b>üë§ Jij (${playerName})</b><br>Je bent op zoek naar de vos!`);
                }

              function updateMap(location) {
    const markerId = location.trackerId;
    
    if (markers[markerId]) {
        map.removeLayer(markers[markerId]);
    }

    const iconType = location.isVos ? icons.vos : icons.zoeker;
    const popupText = location.isVos 
        ? `<b>ü¶ä DE VOS!</b><br>${location.name}<br><small>Ga hem vangen!</small>` 
        : `<b>üë§ ${location.name}</b><br><small>Mede-zoeker</small>`;

    markers[markerId] = L.marker([location.lat, location.lng], { 
        icon: iconType 
    })
    .addTo(map)
    .bindPopup(popupText);

    // VOS: Alleen eerste keer centreren
    if (location.isVos && !window.vosIsGecentreerd) {
        map.setView([location.lat, location.lng], 14);
        window.vosIsGecentreerd = true;
        console.log('üó∫Ô∏è Eerste keer vos gecentreerd');
    }
    
    if (location.isVos) {
        updateVosDistance();
    }
}

                function updateVosDistance() {
                    if (!vosLocation || !markers[TRACKER_ID]) return;
                    
                    const zoekerLoc = markers[TRACKER_ID].getLatLng();
                    const distance = calculateDistance(
                        zoekerLoc.lat, zoekerLoc.lng,
                        vosLocation.lat, vosLocation.lng
                    );
                    
                    const distanceText = distance < 1000 
                        ? `${Math.round(distance)} meter` 
                        : `${(distance/1000).toFixed(1)} km`;
                        
                    document.getElementById('status').innerHTML = 
                        `<div class="vos-alert">
                            ü¶ä VOS GEVONDEN! - ${distanceText} van jou
                         </div>`;
                }

                function calculateDistance(lat1, lon1, lat2, lon2) {
                    const R = 6371000;
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = 
                        Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                }

                function handleLocationError(error) {
                    console.error('Locatie fout:', error);
                    let message = 'Locatie fout: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Toegang geweigerd. Sta locatie toe in browser instellingen.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Locatie informatie niet beschikbaar.';
                            break;
                        case error.TIMEOUT:
                            message += 'Locatie request timeout.';
                            break;
                        default:
                            message += 'Onbekende fout.';
                    }
                    document.getElementById('status').innerHTML = 
                        `<span style="color: #e74c3c;">‚ùå ${message}</span>`;
                }

                console.log('‚úÖ Zoeker app klaar!');
                
            } catch (error) {
                console.error('üí• Error in zoeker:', error);
                document.getElementById('status').innerHTML = 
                    `<div class="error">Zoeker error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
