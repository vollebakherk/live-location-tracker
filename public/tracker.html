<!DOCTYPE html>
<html>
<head>
    <title>Vossenjacht - Word de Vos</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #2c3e50;
            color: white;
        }
        .header {
            padding: 20px;
            background: #e74c3c;
            text-align: center;
        }
        .controls {
            padding: 15px;
            background: #34495e;
            text-align: center;
        }
        .password-section {
            padding: 15px;
            background: #8e44ad;
            text-align: center;
            margin-bottom: 10px;
        }
        input {
            padding: 10px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            padding: 12px 25px;
            margin: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover { background: #c0392b; }
        button.stop { background: #95a5a6; }
        button.stop:hover { background: #7f8c8d; }
        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        #status { 
            margin-top: 10px; 
            font-size: 14px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }
        #map { flex-grow: 1; width: 100%; }
        .vos-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü¶ä Vossenjacht - Word de Vos</h1>
        <p>Voer het wachtwoord in om de vos te worden</p>
    </div>

    <div class="password-section" id="passwordSection">
        <h3>üîê Word de Vos</h3>
        <input type="password" id="passwordInput" placeholder="Voer vos wachtwoord in">
        <input type="text" id="playerName" placeholder="Jouw naam">
        <button onclick="becomeVos()">ü¶ä Word de Vos</button>
        <div id="passwordStatus"></div>
    </div>

    <div class="controls" id="controlsSection" style="display: none;">
        <h3>ü¶ä Je bent de VOS!</h3>
        <button onclick="startSharing()">üìç Start Vos Tracking</button>
        <button class="stop" onclick="stopSharing()">‚èπÔ∏è Stop Vos</button>
        <button class="stop" onclick="stopBeingVos()">üö™ Stop Als Vos</button>
        <div id="status">Klik op Start Vos Tracking om je locatie te delen</div>
    </div>

    <div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    console.log('üéØ Tracker wordt geladen...');
    console.log('üîç Socket.io direct check:', typeof io);
    console.log('üîç Leaflet direct check:', typeof L);
    
    // Wacht tot socket.io geladen is
    function waitForSocketIO(callback) {
        if (typeof io !== 'undefined') {
            console.log('‚úÖ Socket.io is geladen!');
            callback();
        } else {
            console.log('‚è≥ Wacht op socket.io...');
            setTimeout(function() {
                waitForSocketIO(callback);
            }, 100);
        }
    }
    
    waitForSocketIO(function() {
        console.log('üöÄ Start app initialisatie...');
        initializeApp();
    });

    function initializeApp() {
        console.log('üöÄ Initializing app met Socket.io...');
        
        try {
            const socket = io();
            console.log('‚úÖ Socket.io verbonden!');
            
            let map, currentMarker, accuracyCircle;
            let watchId = null;
            let isVos = false;
            const TRACKER_ID = 'vos-' + Math.random().toString(36).substr(2, 5);

            console.log('üÜî Tracker ID:', TRACKER_ID);

            // Vos icon
            const vosIcon = L.divIcon({
                className: 'vos-icon',
                html: `
                    <div style="
                        background: #e74c3c;
                        width: 25px;
                        height: 25px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 15px rgba(231, 76, 60, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        color: white;
                        font-size: 12px;
                    ">ü¶ä</div>
                `,
                iconSize: [31, 31],
                iconAnchor: [15, 15]
            });

            // Initialiseer kaart
            map = L.map('map').setView([50.9010206, 5.3104384], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            console.log('üó∫Ô∏è Kaart ge√Ønitialiseerd');

            // Socket events
            socket.on('connect', () => {
                console.log('‚úÖ Verbonden met server! Socket ID:', socket.id);
            });

            socket.on('vosStatus', (data) => {
                console.log('ü¶ä Vos status:', data);
                if (data.hasVos && !isVos) {
                    document.getElementById('passwordSection').innerHTML = `
                        <h3>‚ùå Er is al een vos!</h3>
                        <p>${data.vosName} is momenteel de vos.</p>
                        <p>Wacht tot de vos stopt of probeer het later opnieuw.</p>
                    `;
                }
            });

            socket.on('vosSuccess', (data) => {
                console.log('‚úÖ Vos geworden:', data);
                isVos = true;
                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('controlsSection').style.display = 'block';
                document.getElementById('passwordStatus').innerHTML = 
                    `<div class="success">${data.message}</div>`;
            });

            socket.on('error', (message) => {
                console.error('‚ùå Socket error:', message);
                document.getElementById('passwordStatus').innerHTML = 
                    `<div class="error">${message}</div>`;
            });

            // Maak functies globaal beschikbaar
            window.becomeVos = function() {
                console.log('ü¶ä Word vos clicked');
                const password = document.getElementById('passwordInput').value;
                const playerName = document.getElementById('playerName').value || 'Anonieme Vos';
                
                if (!password) {
                    document.getElementById('passwordStatus').innerHTML = 
                        '<div class="error">Voer een wachtwoord in</div>';
                    return;
                }

                console.log('ü¶ä Vos aanvraag:', { playerName, TRACKER_ID });
                
                socket.emit('becomeVos', {
                    password: password,
                    trackerId: TRACKER_ID,
                    name: playerName
                });
            }

            window.stopBeingVos = function() {
                console.log('ü¶ä Stop als vos');
                socket.emit('stopVos');
                isVos = false;
                document.getElementById('passwordSection').style.display = 'block';
                document.getElementById('controlsSection').style.display = 'none';
                document.getElementById('passwordSection').innerHTML = `
                    <h3>üîê Word de Vos</h3>
                    <input type="password" id="passwordInput" placeholder="Voer vos wachtwoord in">
                    <input type="text" id="playerName" placeholder="Jouw naam">
                    <button onclick="becomeVos()">ü¶ä Word de Vos</button>
                    <div id="passwordStatus"></div>
                `;
                document.getElementById('status').innerHTML = 'Je bent geen vos meer';
            }

            window.startSharing = function() {
                console.log('üìç Start sharing clicked, isVos:', isVos);
                
                if (!isVos) {
                    alert('Je moet eerst de vos worden!');
                    return;
                }

                if (!navigator.geolocation) {
                    alert('Geolocatie niet ondersteund');
                    return;
                }

                document.getElementById('status').innerHTML = 
                    '<span style="color: #2ecc71;">üî¥ VOS LIVE - Ren maar hard!</span>';

                navigator.geolocation.getCurrentPosition(sendLocationToServer);
                watchId = navigator.geolocation.watchPosition(
                    sendLocationToServer,
                    handleLocationError,
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }

            window.stopSharing = function() {
                console.log('‚èπÔ∏è Stop sharing');
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                document.getElementById('status').innerHTML = '‚èπÔ∏è Vos tracking gestopt';
            }

            function sendLocationToServer(position) {
                if (!isVos) {
                    console.log('‚ùå Niet vos, locatie niet verzonden');
                    return;
                }

                const locationData = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    trackerId: TRACKER_ID,
                    name: document.getElementById('playerName')?.value || 'De Vos',
                    type: "vos"
                };

                console.log('üìç Stuur vos locatie:', locationData);
                socket.emit('updateLocation', locationData);
                updateOwnMap(locationData);
            }

           function updateOwnMap(location) {
    console.log('üó∫Ô∏è Update eigen kaart:', location);
    
    if (currentMarker) map.removeLayer(currentMarker);
    if (accuracyCircle) map.removeLayer(accuracyCircle);

    currentMarker = L.marker([location.lat, location.lng], { 
        icon: vosIcon 
    })
    .addTo(map)
    .bindPopup(`<b>ü¶ä Jij bent de vos!</b><br>Ren maar hard!`)
    .openPopup();

    accuracyCircle = L.circle([location.lat, location.lng], {
        color: '#e74c3c',
        fillColor: '#e74c3c',
        fillOpacity: 0.1,
        radius: location.accuracy
    }).addTo(map);

    // ALLEEN centreren bij eerste update, daarna niet meer
    if (!window.kaartIsGecentreerd) {
        map.setView([location.lat, location.lng], 16);
        window.kaartIsGecentreerd = true;
        console.log('üó∫Ô∏è Eerste keer kaart gecentreerd op vos');
    }
}
            function handleLocationError(error) {
                console.error('‚ùå Locatie fout:', error);
                document.getElementById('status').innerHTML = 
                    '<span style="color: #e74c3c;">‚ùå Locatie fout: ' + error.message + '</span>';
            }
            
            console.log('‚úÖ Vossenjacht app klaar!');
            
        } catch (error) {
            console.error('üí• Error in app:', error);
            document.getElementById('passwordStatus').innerHTML = 
                `<div class="error">App error: ${error.message}</div>`;
        }
    }
</script>
</body>
</html>
