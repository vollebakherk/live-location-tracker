const socket = io();
let map, currentMarker, accuracyCircle;
const TRACKER_ID = 'main-tracker';

// Initialize map
map = L.map('map').setView([50.9010206, 5.3104384], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Toon verbindingsstatus
document.getElementById('status').innerHTML = 'üü° Verbinden met tracker...';

// Socket events
socket.on('connect', () => {
    console.log('‚úÖ Verbonden met server');
    document.getElementById('status').innerHTML = 'üü¢ Verbonden - wacht op locatie...';
    
    // JOIN de tracker room direct na connectie
    socket.emit('joinTracker', TRACKER_ID);
    console.log('üì° Joined tracker room:', TRACKER_ID);
});

socket.on('locationUpdate', (location) => {
    console.log('üìç Locatie ontvangen:', location);
    updateMap(location);
    updateStatus(location);
});

socket.on('disconnect', () => {
    console.log('üî¥ Verbinding verbroken');
    document.getElementById('status').innerHTML = 'üî¥ Verbinding verbroken - probeer opnieuw laden';
});

socket.on('connect_error', (error) => {
    console.error('‚ùå Verbindings fout:', error);
    document.getElementById('status').innerHTML = '‚ùå Verbindings fout - refresh pagina';
});

// Update kaart met locatie
function updateMap(location) {
    // Verwijder oude layers
    if (currentMarker) map.removeLayer(currentMarker);
    if (accuracyCircle) map.removeLayer(accuracyCircle);

    // Pulsierende marker
    const liveIcon = L.divIcon({
        className: 'live-marker',
        html: `
            <div style="
                background: #e74c3c;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
                animation: pulse 1.5s infinite;
            "></div>
        `,
        iconSize: [26, 26],
        iconAnchor: [13, 13]
    });

    // Nieuwe marker
    currentMarker = L.marker([location.lat, location.lng], { icon: liveIcon })
        .addTo(map)
        .bindPopup(`
            <div style="min-width: 250px;">
                <b>üìç ${location.name || 'Live Tracker'}</b><br>
                Lat: ${location.lat.toFixed(6)}<br>
                Lng: ${location.lng.toFixed(6)}<br>
                Nauwkeurigheid: ${Math.round(location.accuracy)}m<br>
                Tijd: ${new Date(location.timestamp).toLocaleTimeString()}
            </div>
        `)
        .openPopup();

    // Nauwkeurigheidscirkel
    accuracyCircle = L.circle([location.lat, location.lng], {
        color: '#e74c3c',
        fillColor: '#e74c3c',
        fillOpacity: 0.1,
        weight: 1,
        radius: location.accuracy
    }).addTo(map);

    // Centreer kaart op locatie
    map.setView([location.lat, location.lng], 16);
}

function updateStatus(location) {
    document.getElementById('status').innerHTML = `
        <span style="color: #27ae60;">
            üî¥ LIVE - ${location.name || 'Tracker'} - 
            ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)} - 
            ${Math.round(location.accuracy)}m - 
            ${new Date(location.timestamp).toLocaleTimeString()}
        </span>
    `;
}

// Vraag om locatie update (voor testing)
function requestLocationUpdate() {
    socket.emit('requestLocation', TRACKER_ID);
    console.log('üîÑ Locatie update aangevraagd');
}

// Auto-request locatie elke 10 seconden (fallback)
setInterval(() => {
    if (socket.connected) {
        requestLocationUpdate();
    }
}, 10000);

// Initial request
setTimeout(requestLocationUpdate, 2000);
