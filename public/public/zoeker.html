<!DOCTYPE html>
<html>
<head>
    <title>Vossenjacht - Zoeker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #2c3e50;
            color: white;
        }
        .header {
            padding: 20px;
            background: #3498db;
            text-align: center;
        }
        .controls {
            padding: 15px;
            background: #34495e;
            text-align: center;
        }
        button {
            padding: 12px 25px;
            margin: 0 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover { background: #2980b9; }
        button.stop { background: #95a5a6; }
        button.stop:hover { background: #7f8c8d; }
        #status { 
            margin-top: 10px; 
            font-size: 14px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }
        #map { flex-grow: 1; width: 100%; }
        .zoeker-badge {
            background: #3498db;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ Vossenjacht - ZOEKER</h1>
        <p>Vind de vos! Jouw locatie wordt ook gedeeld met andere zoekers.</p>
    </div>
    <div class="controls">
        <button onclick="startSharing()">üìç Start Zoeken</button>
        <button class="stop" onclick="stopSharing()">‚èπÔ∏è Stop Zoeken</button>
        <div id="status">Klik op Start Zoeken om te beginnen met zoeken</div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let map, currentMarker, accuracyCircle;
        let watchId = null;
        const TRACKER_ID = 'zoeker-' + Math.random().toString(36).substr(2, 5); // Unieke ID

        // Custom icons
        const icons = {
            vos: L.divIcon({
                className: 'vos-icon',
                html: `
                    <div style="
                        background: #e74c3c;
                        width: 25px;
                        height: 25px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 15px rgba(231, 76, 60, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        color: white;
                        font-size: 12px;
                    ">ü¶ä</div>
                `,
                iconSize: [31, 31],
                iconAnchor: [15, 15]
            }),
            zoeker: L.divIcon({
                className: 'zoeker-icon',
                html: `
                    <div style="
                        background: #3498db;
                        width: 22px;
                        height: 22px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 0 10px rgba(52, 152, 219, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                        color: white;
                        font-size: 10px;
                    ">üë§</div>
                `,
                iconSize: [28, 28],
                iconAnchor: [14, 14]
            })
        };

        const markers = {}; // Bewaar alle markers

        // Initialiseer kaart
        map = L.map('map').setView([50.9010206, 5.3104384], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Luister naar ALLE trackers
        socket.on('locationUpdate', (location) => {
            updateMap(location);
        });

        function startSharing() {
            if (!navigator.geolocation) {
                alert('Geolocatie niet ondersteund');
                return;
            }

            document.getElementById('status').innerHTML = 
                '<span style="color: #2ecc71;">üî¥ ZOEKEN LIVE - Je ziet alle spelers</span>';

            // Eerste locatie
            navigator.geolocation.getCurrentPosition(sendLocationToServer);

            // Continue tracking
            watchId = navigator.geolocation.watchPosition(
                sendLocationToServer,
                handleLocationError,
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function stopSharing() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            document.getElementById('status').innerHTML = '‚èπÔ∏è Zoeken gestopt';
        }

        function sendLocationToServer(position) {
            const locationData = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                trackerId: TRACKER_ID,
                name: "Zoeker " + TRACKER_ID.substr(8, 3),
                type: "zoeker"
            };

            console.log('üë§ Zoeker locatie:', locationData);

            // Stuur naar server
            socket.emit('updateLocation', locationData);
        }

        function updateMap(location) {
            const markerId = location.trackerId;
            
            // Verwijder oude marker
            if (markers[markerId]) {
                map.removeLayer(markers[markerId]);
            }

            // Bepaal icon type
            const iconType = location.type === 'vos' ? icons.vos : icons.zoeker;
            const popupText = location.type === 'vos' 
                ? `<b>ü¶ä DE VOS!</b><br>Vind hem!` 
                : `<b>üë§ ${location.name}</b><br>Mede-zoeker`;

            // Nieuwe marker
            markers[markerId] = L.marker([location.lat, location.lng], { 
                icon: iconType 
            })
            .addTo(map)
            .bindPopup(popupText);

            // Als het de vos is, centreer de kaart
            if (location.type === 'vos') {
                map.setView([location.lat, location.lng], 16);
                document.getElementById('status').innerHTML = 
                    `<span style="color: #e74c3c;">üî¥ VOS GEVONDEN! - ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</span>`;
            }
        }

        function handleLocationError(error) {
            console.error('Locatie fout:', error);
            document.getElementById('status').innerHTML = 
                '<span style="color: #e74c3c;">‚ùå Locatie fout: ' + error.message + '</span>';
        }
    </script>
</body>
</html>
